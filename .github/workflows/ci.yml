name: CI

on:
    push:
        branches: [ main, master ]
        tags: [ '*' ]
    pull_request:
        branches: [ '**' ]
    workflow_dispatch:

jobs:
    quality-and-tests:
        name: PHP ${{ matrix.php }} + Symfony ${{ matrix.symfony }}
        runs-on: ubuntu-latest
        services:
            mysql:
                image: mysql:8.0
                env:
                    MYSQL_ROOT_PASSWORD: root
                    MYSQL_DATABASE: test_db
                    MYSQL_USER: test_user
                    MYSQL_PASSWORD: test_password
                ports:
                    - 3306:3306
                options: >-
                    --health-cmd="mysqladmin ping -h 127.0.0.1 -proot" 
                    --health-interval=10s 
                    --health-timeout=5s 
                    --health-retries=5
            postgres:
                image: postgres:15
                env:
                    POSTGRES_USER: test_user
                    POSTGRES_PASSWORD: test_password
                    POSTGRES_DB: test_db
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd="pg_isready -U test_user" 
                    --health-interval=10s 
                    --health-timeout=5s 
                    --health-retries=5
        strategy:
            fail-fast: false
            matrix:
                php: [ '8.2', '8.3', '8.4', '8.5' ]
                symfony: [ '6.4', '7.4', '8.*' ]
                exclude:
                    -   php: '8.4'
                        symfony: '6.4'
                    -   php: '8.5'
                        symfony: '6.4'
        env:
            MYSQL_HOST: 127.0.0.1
            MYSQL_PORT: 3306
            MYSQL_USER: root
            MYSQL_PASSWORD: root
            MYSQL_DATABASE: test_db
            PGHOST: 127.0.0.1
            PGPORT: 5432
            PGUSER: test_user
            PGPASSWORD: test_password
            PGDATABASE: test_db
        steps:
            -   name: Checkout repository
                uses: actions/checkout@v4

            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: ${{ matrix.php }}
                    coverage: none
                    tools: composer:v2
                    extensions: mbstring, intl, json, dom, curl, pdo, pdo_mysql, pdo_pgsql, pdo_sqlite, zip

            -   name: Get Composer cache directory
                id: composer-cache
                run: |
                    echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

            -   name: Cache Composer dependencies
                uses: actions/cache@v4
                with:
                    path: ${{ steps.composer-cache.outputs.dir }}
                    key: ${{ runner.os }}-composer-${{ matrix.php }}-${{ matrix.symfony }}-${{ hashFiles('composer.lock', 'composer.json') }}
                    restore-keys: |
                        ${{ runner.os }}-composer-${{ matrix.php }}-${{ matrix.symfony }}-
                        ${{ runner.os }}-composer-

            -   name: Configure dependencies for matrix
                run: |
                    composer require --no-interaction --no-update "symfony/framework-bundle:${{ matrix.symfony }}"

            -   name: Install dependencies
                run: composer update --prefer-dist --no-interaction --no-progress --ansi --with-all-dependencies

            -   name: Export test database URLs
                run: |
                    echo "TESTAPP_DATABASE_URL_MYSQL=mysql://test_user:test_password@127.0.0.1:3306/test_db?serverVersion=8.0.1&charset=utf8mb4" >> $GITHUB_ENV
                    echo "TESTAPP_DATABASE_URL_PGSQL=postgresql://test_user:test_password@127.0.0.1:5432/test_db?serverVersion=15" >> $GITHUB_ENV

            -   name: Validate composer
                run: composer validate --ansi

            -   name: PHP CS Fixer (dry-run)
                run: vendor/bin/php-cs-fixer --version && vendor/bin/php-cs-fixer fix --dry-run --diff --ansi

            -   name: Rector (dry-run)
                run: vendor/bin/rector --version && vendor/bin/rector process --dry-run --ansi

            -   name: PHPStan
                run: vendor/bin/phpstan --version && vendor/bin/phpstan analyse --no-progress --ansi --memory-limit=1G

            -   name: Install PostgreSQL client tools
                run: |
                    sudo apt-get update
                    sudo apt-get install -y postgresql-client

            -   name: PHPUnit
                run: |
                    vendor/bin/simple-phpunit --testdox --colors=always

    release:
        name: Create Release
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/')
        needs: [ quality-and-tests ]
        permissions:
            contents: write
        steps:
            -   name: Create GitHub Release
                uses: softprops/action-gh-release@v2
                with:
                    generate_release_notes: true
